{% extends "_base.html" %}

{% block content %}
    <header class="navbar sticky-top bg-dark" role="navigation">
        <div class="col-sm-3 col-12">
            <button id="pull-button" class="btn btn-primary btn-block job-button" type="button">
                Pull
            </button>
        </div>
        <div class="col-sm-3 col-12">
            <button id="archivize-button" class="btn btn-primary btn-block job-button" type="button">
                Archivize
            </button>
        </div>
        <div class="col-sm-4"></div>
        <div class="col-sm-2 col-12 text-white text-right">
            <span id="battery-level"></span>
            <span id="battery-charging-icon"></span>
        </div>
    </header>

    <div class="container-fluid bg-light col-10">
        <ul id="quest-list" class="list-group">
        </ul>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        const pullButton = $("#pull-button");
        const pullButtonReadyHTML = pullButton.html();
        const pullButtonInProgressHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Pulling...';
        const pullButtonFailedHTML = "Pull failed";

        const autoPullInterval = 60 * 1000;

        const archivizeButton = $("#archivize-button");
        const archivizeButtonReadyHTML = archivizeButton.html();
        const archivizeButtonInProgressHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Archivizing...';
        const archivizeButtonFailedHTML = "Archivization failed";

        const jobButtons = $(".job-button");

        const batteryLevelField = $("#battery-level");
        const batteryChargingIconField = $("#battery-charging-icon");

        const batteryChargingIcon = '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-battery-charging" fill="currentColor" xmlns="http://www.w3.org/2000/svg"> <path d="M14.5 9.5a1.5 1.5 0 0 0 0-3v3z"/> <path fill-rule="evenodd" d="M9.585 2.568a.5.5 0 0 1 .226.58L8.677 6.832h1.99a.5.5 0 0 1 .364.843l-5.334 5.667a.5.5 0 0 1-.842-.49L5.99 9.167H4a.5.5 0 0 1-.364-.843l5.333-5.667a.5.5 0 0 1 .616-.09z"/> <path fill-rule="evenodd" d="M6.332 4H2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2.072l.307-1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h3.391l.941-1zM4.45 6H2v4h1.313a1.5 1.5 0 0 1-.405-2.361L4.45 6zm.976 5l-.308 1H6.96l.21-.224h.001l.73-.776H6.53l-.085.09.028-.09H5.426zm1.354-1H5.733l.257-.833H4a.5.5 0 0 1-.364-.843l.793-.843L5.823 6h1.373L5.157 8.167h1.51a.5.5 0 0 1 .478.647L6.78 10zm.69 0h1.374l1.394-1.482.793-.842a.5.5 0 0 0-.364-.843h-1.99L8.933 6H7.887l-.166.54-.199.646A.5.5 0 0 0 8 7.833h1.51L7.47 10zm.725-5H9.24l.308-1H7.706l-.942 1h1.374l.085-.09-.028.09zm2.4-1l-.308 1H12a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H9.276l-.942 1H12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.405zm-.378 6H12V8.02a1.499 1.499 0 0 1-.241.341L10.217 10zM12 6.646V6h-.646a1.5 1.5 0 0 1 .646.646z"/> </svg>'
        const batteryDischargingIcon = '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-battery-half" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n  <path fill-rule="evenodd" d="M12 5H2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1zM2 4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H2z"/>\n  <path d="M2 6h5v4H2V6zm12.5 3.5a1.5 1.5 0 0 0 0-3v3z"/>\n</svg>'

        let jobInProgress = false;

        const questList = $("#quest-list");

        function doInitialPull() {
            return doInitializeQuestPull()
                .then(doInvokeQuestPull)
                .then(doRestoreQuestList)
                .then(doFinishPull)
                .then(doStoreQuestOrder)
                .fail(doNotifyPullFailure);
        }

        function doPull() {
            return doInitializeQuestPull()
                .then(doInvokeQuestPull)
                .then(doUpdateQuestList)
                .then(doFinishPull)
                .then(doStoreQuestOrder)
                .fail(doNotifyPullFailure);
        }

        function doInitializeQuestPull() {
            let deferred = $.Deferred();

            if (jobInProgress) {
                return;
            }
            jobInProgress = true;
            console.log("Pulling...")
            jobButtons.addClass("disabled")
            pullButton.html(pullButtonInProgressHTML);

            deferred.resolve()

            return deferred;
        }

        function doInvokeQuestPull() {
            return $.get("{{ url_for("board_api.quests_pull") }}");
        }

        function doUpdateQuestList() {
            return $.getJSON("{{ url_for("board_api.quests_today") }}")
                .done(function (data) {
                    updateQuestList(data);
                });
        }

        function doRestoreQuestList() {
            return $.getJSON("{{ url_for("board_api.quests_today") }}")
                .done(function (data) {
                    restoreQuestList(data);
                    updateQuestList(data);
                });
        }

        function doFinishPull() {
            let deferred = $.Deferred();

            pullButton.html(pullButtonReadyHTML);
            pullButton.addClass("btn-primary");
            pullButton.removeClass("btn-danger");
            jobButtons.removeClass("disabled")
            jobInProgress = false;

            deferred.resolve();
            return deferred;
        }

        function doNotifyPullFailure() {
            let deferred = $.Deferred();

            pullButton.html(pullButtonFailedHTML);
            pullButton.addClass("btn-danger");
            pullButton.removeClass("btn-primary");
            jobButtons.removeClass("disabled");
            jobInProgress = false;

            deferred.resolve();
            return deferred;
        }

        function getQuestIdentifier(questId) {
            return `quest-${questId}`;
        }

        function parseQuestIdentifier(questIdentifier) {
            return questIdentifier.split("-")[1];
        }

        function htmlEscape(str) {
            return $("<div>").text(str).html();
        }

        function formatQuestBody(data) {
            return `${htmlEscape(data.name)}`;
        }

        function formatQuestItem(data) {
            let formatted = $(`<li id="${getQuestIdentifier(data.id)}" class="list-group-item quest-item">${formatQuestBody(data)}</li>`);
            setQuestItemDoneFlag(formatted, data.is_done);
            return formatted;
        }

        function updateQuest(quest, data) {
            quest.html(formatQuestBody(data));
            setQuestItemDoneFlag(quest, data.is_done);
        }

        function createQuest(data) {
            questList.append(formatQuestItem(data));
        }

        function createOrUpdateQuest(data) {
            let identifier = getQuestIdentifier(data.id);
            let quest = questList.find(`[id="${identifier}"]`);
            if (quest.length > 0) {
                updateQuest(quest, data);
            } else {
                createQuest(data);
            }
        }

        function removeOutdatedQuests(data) {
            const ids = $.map(data, x => getQuestIdentifier(x.id));
            questList.find("li").each(function () {
                const id = $(this).attr("id");
                if (! ids.includes(id)) {
                    $(this).remove();
                }
            });
        }

        function updateQuestList(data) {
            data.forEach(questData => createOrUpdateQuest(questData));
            removeOutdatedQuests(data);
        }

        function doGetQuestOrder() {
            let deferred = $.Deferred();

            let quests = questList.find("li");
            let order = $.map(quests, quest => parseQuestIdentifier(quest.id))

            deferred.resolve(order);
            return deferred;
        }

        function doSaveQuestOrderToCache(order) {
            let deferred = $.Deferred();

            let data = JSON.stringify(order);
            Cookies.set("questOrder", data);

            deferred.resolve(order);
            return deferred;
        }

        function doStoreQuestOrder() {
            return doGetQuestOrder()
                .then(doSaveQuestOrderToCache);
        }

        function tryRestoreQuestById(questId, data) {
            let candidates = data.filter(x => x.id == questId)
            if (candidates.length > 0) {
                createOrUpdateQuest(candidates[0]);
            }
        }

        function restoreQuestList(data) {
            let orderData = Cookies.get("questOrder");
            if (orderData) {
                let order = JSON.parse(orderData);

                order.forEach(questId => tryRestoreQuestById(questId, data));
            }
        }

        function doArchivize() {
            return doInitializeArchivization()
                .then(doUpdateServerArchivizationStatus)
                .then(doUpdateQuestList)
                .then(doFinishArchivization)
                .fail(doNotifyArchivizationFailure)
        }

        function doInitializeArchivization() {
            let deferred = $.Deferred();

            if (jobInProgress) {
                return;
            }
            jobInProgress = true;
            console.log("Archivizing...")
            jobButtons.addClass("disabled")
            archivizeButton.html(archivizeButtonInProgressHTML);

            deferred.resolve()

            return deferred;
        }

        function doFinishArchivization() {
            let deferred = $.Deferred();

            archivizeButton.html(archivizeButtonReadyHTML);
            archivizeButton.addClass("btn-primary");
            archivizeButton.removeClass("btn-danger");
            jobButtons.removeClass("disabled")
            jobInProgress = false;

            deferred.resolve();
            return deferred;
        }

        function doNotifyArchivizationFailure() {
            let deferred = $.Deferred();

            archivizeButton.html(archivizeButtonFailedHTML);
            archivizeButton.addClass("btn-danger");
            archivizeButton.removeClass("btn-primary");
            jobButtons.removeClass("disabled");
            jobInProgress = false;

            deferred.resolve();
            return deferred;
        }

        function doUpdateServerArchivizationStatus() {
            let questsToArchivize = questList.find("li.quest-done");
            let data = {
                quests: $.map(questsToArchivize, quest => parseQuestIdentifier(quest.id))
            };
            return $.post("{{ url_for("board_api.bulk_archivize") }}", data);
        }

        function doToggleDone() {
            return doToggleDoneClass($(this))
                .then(doUpdateServerDoneStatus)
        }

        function doToggleDoneClass(questItem) {
            let deferred = $.Deferred();

            const targetDoneFlag = !questItem.hasClass("quest-done");
            setQuestItemDoneFlag(questItem, targetDoneFlag);

            deferred.resolve(questItem);
            return deferred;
        }

        function setQuestItemDoneFlag(questItem, flag) {
            if (flag) {
                questItem.addClass("quest-done");
                questItem.addClass("bg-success");
            } else {
                questItem.removeClass("quest-done");
                questItem.removeClass("bg-success");
            }
        }

        function doUpdateServerDoneStatus(questItem) {
            const questId = parseQuestIdentifier(questItem.attr("id"));
            const is_done = questItem.hasClass("quest-done");
            const url = "{{ url_for("board_api.quests", quest_id="QUEST_ID") }}".replace("QUEST_ID", questId);

            return $.post(url, {is_done: is_done});
        }

        function getBatteryChargingIcon(charging) {
            if (charging) {
                return batteryChargingIcon;
            } else {
                return batteryDischargingIcon;
            }
        }

        function setBatteryLevel(level) {
            batteryLevelField.text(`${level * 100}%`);
        }

        function setBatteryCharging(charging) {
            batteryChargingIconField.html(getBatteryChargingIcon(charging));
        }

        navigator.getBattery().then(function (battery) {
            setBatteryLevel(battery.level);
            setBatteryCharging(battery.charging);

            battery.onlevelchange = function () {
                setBatteryLevel(battery.level);
            }
            battery.onchargingchange = function () {
                setBatteryCharging(battery.charging);
            }
        })

        pullButton.on("click", doPull);
        archivizeButton.on("click", doArchivize);
        $(document).on("click", ".quest-item", doToggleDone);

        questList.sortable({
            update: doStoreQuestOrder
        });
        questList.disableSelection();

        $(function () {
            doInitialPull();
            setInterval(doPull, autoPullInterval);
        });
    </script>
{% endblock %}
